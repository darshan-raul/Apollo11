{% extends "base.html" %}

{% block title %}{{ stage.name }}{% endblock %}

{% block content %}
<div class="card">
    <h1>Stage {{ stage.id }}: {{ stage.name }}</h1>
    <p>{{ stage.description }}</p>

    <div id="status-box" class="card" style="border: 2px solid var(--primary-color);">
        <h2>Current Status: <span id="status-text">{{ progress.status | upper }}</span></h2>
        <div id="telemetry"></div>
    </div>

    {% if progress.status == 'available' or progress.status == 'failed' or progress.status == 'completed' %}
    <div id="action-area">
        <button onclick="startSimulation()">
            {% if progress.status == 'failed' %}RETRY SIMULATION{% else %}START SIMULATION SEQUENCE{% endif %}
        </button>
    </div>
    {% elif progress.status == 'locked' %}
    <p style="color: red;">STAGE LOCKED. COMPLETE PREVIOUS STAGE.</p>
    {% endif %}

    <button onclick="window.location.href='/dashboard'" style="margin-top: 20px; background: #333;">Back to
        Dashboard</button>
</div>

<script>
    const stageId = "{{ stage.id }}";
    const userId = "{{ user.ID }}"; // Assuming user object has ID 

    async function startSimulation() {
        const btn = document.querySelector('#action-area button');
        btn.disabled = true;
        btn.innerText = "INITIATING...";

        try {
            const res = await fetch(`/api/simulation/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ stage_id: parseInt(stageId) })
            });

            if (res.ok) {
                document.getElementById('status-text').innerText = "IN PROGRESS";
                pollStatus();
            } else {
                const data = await res.json();
                alert("Error: " + (data.detail || "Unknown error"));
                btn.disabled = false;
                btn.innerText = "START SIMULATION SEQUENCE";
            }
        } catch (e) {
            console.error(e);
            alert("Connection Error");
            btn.disabled = false;
        }
    }

    async function pollStatus() {
        const interval = setInterval(async () => {
            try {
                const res = await fetch(`/api/status/${stageId}`);
                const data = await res.json();

                document.getElementById('status-text').innerText = data.status.toUpperCase();

                if (data.status === 'completed' || data.status === 'failed') {
                    clearInterval(interval);

                    if (data.status === 'completed') {
                        alert("MISSION SUCCESSFUL!");
                    } else {
                        alert("MISSION FAILED. TRY AGAIN.");
                    }
                    location.reload();
                }
            } catch (e) {
                console.error("Polling error", e);
            }
        }, 2000);
    }

    {% if progress.status == 'in_progress' %}
    pollStatus();
    {% endif %}
</script>
{% endblock %}