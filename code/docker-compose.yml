services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: apollo11
    ports:
      - "5432:5432"
    volumes:
      - ./database/migrations:/docker-entrypoint-initdb.d
    networks:
      - apollo-net

  keycloak:
    image: quay.io/keycloak/keycloak:23.0.6
    command: start-dev --import-realm
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/apollo11
      KC_DB_USERNAME: postgres
      KC_DB_PASSWORD: postgres
      KC_DB_SCHEMA: keycloak
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm.json
    ports:
      - "8081:8080"
    depends_on:
      - postgres
    networks:
      - apollo-net

  core-api:
    build: ./core-api
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/apollo11
      KEYCLOAK_URL: http://keycloak:8080
      QUIZ_SERVICE_URL: http://quiz-service:8080
      REALM: apollo11
      CLIENT_ID: apollo11-portal
    ports:
      - "8000:8000"
    depends_on:
      - postgres
      - keycloak
    networks:
      - apollo-net

  quiz-service:
    build: ./quiz-service
    environment:
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/apollo11
    ports:
      - "8082:8080"
    depends_on:
      - postgres
    networks:
      - apollo-net

  portal:
    build:
      context: ./portal
      args:
        VITE_KEYCLOAK_URL: http://localhost:8081/realms/apollo11
        VITE_API_URL: http://localhost:8000
    ports:
      - "3000:80"
    networks:
      - apollo-net
    depends_on:
      - core-api

  admin-dashboard:
    build: ./admin-dashboard
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/apollo11
      KEYCLOAK_URL: http://keycloak:8080
    ports:
      - "8501:8501"
    depends_on:
      - postgres
      - keycloak
    networks:
      - apollo-net

networks:
  apollo-net:
    driver: bridge
